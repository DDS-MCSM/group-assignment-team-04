#' Updates malware domain information csv
#'
#' This return the malware informaiton extracted from http://www.malwaredomainlist.com
#'
#' @export
update_malware_data <- function()
{
  mdlfile <- "./data/malware-domain-list.csv"
  utils::download.file(url="http://www.malwaredomainlist.com/mdlcsv.php", destfile = mdlfile, quiet = F)

  domainListZip <- "./data/domains.list.zip"
  utils::download.file(url="https://github.com/mitchellkrogza/Ultimate.Hosts.Blacklist/raw/master/domains.list.zip",destfile = domainListZip, quiet = F)
  unzip(domainListZip, exdir = "./data")
}


#' Returns a list of domains blocked by Ultimate.Hosts.Blacklist
#'
#' @return  domains blocked by Ultimate.Hosts.Blacklist
#' @export
read_malware_domains_from_ultimatehostblacklist <- function()
{
  mdfile <- "./data/domains.list"
  if (!file.exists(mdfile))
  {
    update_malware_data();
  }

  domains <- scan(mdfile, what = "", sep = "\n")
  return(domains)
}

#' Returns a dataframe with the information from  malware domain information
#'
#' This return the malware informaiton extracted from http://www.malwaredomainlist.com
#' @return A dataframe with malware information with the following columns:
#' Date, Domain, domainParsed, IP, ReverseLookup, Description, ASN, Country
#' @export
read_malware_data_from_malwaredomainlist <- function()
{
  mdlfile <- "./data/malware-domain-list.csv"
  if (!file.exists(mdlfile))
  {
    update_malware_data();
  }

  malwareRead <- read.csv(file = mdlfile,
                          header = F,
                          col.names = c("Date", "Domain", "IP", "ReverseLookup", "Description","Registrant", "ASN","none", "Country","end"),
                          stringsAsFactors = F)


  malwareRead <- malwareRead %>%
    filter(!is.na(Domain) & Domain != "-") %>%
    mutate(domainParsed = urltools::url_parse(Domain)$domain) %>%
    select(c("Date", "Domain","domainParsed", "IP", "ReverseLookup", "Description","ASN","Country"))

  return(malwareRead)
}


#' Returns a list of malware domains
#'
#' @return  malware domains
#' @export
get_malware_domain_list <- function()
{
  malwaredomainlist <- read_malware_data_from_malwaredomainlist()
  ultimatehostblacklist <- read_malware_domains_from_ultimatehostblacklist()

  domains <- c(ultimatehostblacklist, malwaredomainlist$domainParsed)
  return(domains)
}
