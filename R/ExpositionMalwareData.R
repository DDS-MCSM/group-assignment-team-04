library(dplyr)


#' Build a graph from the dataframe links
#'
#' Green edge are safe domains
#' Red edges are dangerous domains
#'
#' @param domainLinksDf Links of the domain analized
#' @param max_number_domains maximun number of domain to display to avoid many noise on the graph
#' @return
#' @export
build_domain_analyzed_graph <- function(domainLinksDf, max_number_domains = 10)
{
  top_domains <- (domainLinksDf %>%
                    group_by(domain) %>%
                    count() %>%
                    arrange(desc(n)) %>%
                    head(max_number_domains))$domain

  malwareDomains <- (
    domainLinksDf %>%
      filter(contains_malware == T)
  )$domain

  domainLinksDf <- domainLinksDf %>%
    filter(domain %in% top_domains & originDomain %in% top_domains) %>%
    group_by(originDomain, domain, contains_malware) %>%
    count()



  edges_list <- data.frame(from=domainLinksDf$originDomain, to = domainLinksDf$domain)
  graph <- igraph::graph_from_data_frame(edges_list, directed = T)
  graph <- igraph::simplify(graph, remove.loops = TRUE)
  igraph::V(graph)$color <- ifelse(igraph::V(graph) %in% malwareDomains, "red", "green")


  igraph::plot.igraph(graph,
                      edge.label = domainLinksDf$n,
                      edge.arrow.size = 0.5,
                      asp = 0)
}

#' Build a graph including only paths to the malware
#'
#' Green edge are safe domains
#' Red edges are dangerous domains
#'
#' @param domainLinksDf Links of the domain analized
#' @param max_number_domains maximun number of domain to display to avoid many noise on the graph
#' @return
#' @export
build_malware_graph <- function(domainLinksDf, max_number_domains = 10)
{
  levels <- sort(unique(domainLinksDf$level), decreasing = T)

  df <- data.frame()
  for (lvToAnalyze in levels) {
    levelMalware <- domainLinksDf %>% filter(level == lvToAnalyze & contains_malware == T)
    levelLinksToMalware <-  domainLinksDf %>% filter(level == lvToAnalyze & link %in% df$originLink)

    df <- rbind(df, levelMalware)
    df <- rbind(df, levelLinksToMalware)
  }

  domainLinksDf <- df

  malwareDomains <- (
    domainLinksDf %>%
      filter(contains_malware == T)
  )$domain

  domainLinksDf <- domainLinksDf %>%
    group_by(originDomain, domain, contains_malware) %>%
    count()



  edges_list <- data.frame(from=domainLinksDf$originDomain, to = domainLinksDf$domain)
  graph <- igraph::graph_from_data_frame(edges_list, directed = T)
  graph <- igraph::simplify(graph, remove.loops = TRUE)
  igraph::V(graph)$color <- ifelse(igraph::V(graph)$name %in% malwareDomains, "red", "green")


  igraph::plot.igraph(graph,
                      edge.label = domainLinksDf$n,
                      edge.arrow.size = 0.5,
                      asp = 0)
}


